#+OPTIONS: ^:nil
* Background
  Simulate the batch + online case. The online (tpcc) is in high priority compared to batch. The tpcc's qps and latency should be guaranteed from batch. 
* Cluster Deployment
  #+BEGIN_SRC
workstation$ more tidb-on-aws.yaml
 workstation:
   cidr: 172.82.0.0/16                             # The cidr for the VPC
   imageid: ami-07d02ee1eeb0c996c                  # Workstation EC2 instance
   keyname: jay-us-east-01                         # Public key for workstation instance deployment
   keyfile: /home/pi/.ssh/jay-us-east-01.pem       # Private key to access the workstation
   volumeSize: 100                                 # disk size in the workstation
   enable_monitoring: enabled                      # enable the moniroting on the workstation
   instance_type: t2.2xlarge                       # Instance type for PD component
 aws_topo_configs:
   general:
     # debian os
     imageid: ami-07d02ee1eeb0c996c                # Default image id for EC2
     keyname: jay-us-east-01                       # Public key to access the EC2 instance
     keyfile: /home/pi/.ssh/jay-us-east-01.pem     # Private key ti access the EC2 instance
     cidr: 172.83.0.0/16                           # The cidr for the VPC
     instance_type: t2.small                       # Default instance type
     #enable_audit_log: true                        # Enable the audit log
     tidb_version: v7.5.0                          # TiDB version
     excluded_az:                                  # The AZ to be excluded for the subnets
       - us-east-1e
     network_type: nat                             # The flag to decide whether the nat is created in the TiDB VPC
   pd:
     instance_type: t2.medium                      # Instance type for PD component
     count: 3                                      # Number of PD node to be deployed
   tidb:
     instance_type: t2.large                       # Instance type of tidb
     count: 2                                      # Number of TiDB node to be deployed
   tikv:
     -
       instance_type: t2.large                     # Instance type of TiKV
       count: 3                                    # Number of TiKV nodes to be deployed
       volumeSize: 50                              # Storage size for TiKV nodes (GB)
       volumeType: gp3                             # Storage type ex. gp2(default), gp3, io2
       iops: 2000                                  # Storage IOPS(Only for gp3, io2)
workstation$ ./bin/aws tidb deploy rctest /tmp/tidb-on-aws.yaml
Please confirm your topology:
AWS Region:      
Cluster type:    tidb
Cluster name:    rctest
Cluster version: v7.5.0
User Name:       
Key Name:        jay-us-east-01

Component    # of nodes  Instance Type  Image Name             CIDR           User  Placement rule labels
---------    ----------  -------------  ----------             ----           ----  ---------------------
Workstation  1           t2.2xlarge     ami-07d02ee1eeb0c996c  172.82.0.0/16  admin
TiDB         2           t2.large       ami-07d02ee1eeb0c996c  172.83.0.0/16  master
PD           3           t2.medium      ami-07d02ee1eeb0c996c  172.83.0.0/16  master
TiKV         3           t2.large       ami-07d02ee1eeb0c996c  172.83.0.0/16  master
Attention:
    1. If the topology is not what you expected, check your yaml file.
    2. Please confirm there is no port/directory conflicts in same host.
Do you want to continue? [y/N]: (default=N) y
... ...


Execution Time:
Step       Duration(s)
----       -----------
Execution  18m12s
Total      18m12s

Verbose debug logs has been written to /home/pi/.tiup/logs/aws-nodes-debug-2023-12-07-10-51-55.log.
  #+END_SRC
* performance test
  + Test Case
    #+ATTR_HTML: :border 2 :rules all :frame border
    | Test Case        | Comment                                                                                                                                         |
    |------------------+-------------------------------------------------------------------------------------------------------------------------------------------------|
    | TPCC ONLY        | The test only run tpcc against the TiDB to checkout the standard QPS and latency as the standard. All the other test will be compared to it     |
    | TPCC/batch       | The TPCC and batch are run in parallel to see how much performance will be impacted from the batch.                                             |
    | TPCC/batch(100%) | The TPCC and batch whose resource is controlled under 100%. This case we can take it as no resource control since it is allowed to use 100$ RCU |
    | TPCC/batch(%x)   | The TPCC and batch whose resource is controoled under x%.                                                                                       |
  + Execution commands
    #+BEGIN_SRC
workstation$ ./bin/aws tidb perf resource-isolation prepare rctest --sysbench-num-tables 10 --sysbench-execution-time 300 --isolation-mode ResourceControl  --tikv-mode simple
workstation$ ./bin/aws tidb perf resource-isolation run rctest --sysbench-num-tables 10 -i ResourceControl  --batch-size x,50000 --repeats 2 --sysbench-plugin-name tidb_oltp_insert_simple
Test Case         Rows Inserted  reads  writes  queries  events  events/sec  queries  queries/sec  latency_min(ms)  latency_avg(ms)  latency_max(ms)  95th_latency_pct (ms) ms  latency_sum (ms)  Start Time  End Time
---------         -------------  -----  ------  -------  ------  ----------  -------  -----------  ---------------  ---------------  ---------------  ------------------------  ----------------  ----------  --------
TPCC ONLY         0              0      128270  128270   128270  427.56      128270   427.56       4.16             9.35             227.37           12.98                     1199452.36        14:19:37    14:24:40
TPCC/batch        2649643        0      91071   91071    91071   303.56      91071    303.56       4.25             13.17            990.04           27.66                     1199631.62        14:25:19    14:30:22
TPCC/batch(%100)  1187771        0      101215  101215   101215  337.36      101215   337.36       4.24             11.85            208.25           20.74                     1199635.97        14:31:19    14:36:21
TPCC/batch(%80)   1279138        0      92458   92458    92458   308.18      92458    308.18       4.10             12.97            434.11           25.28                     1199633.81        14:37:17    14:42:19
TPCC/batch(%60)   1370505        0      103879  103879   103879  346.26      103879   346.26       3.97             11.55            355.30           20.00                     1199570.90        14:43:10    14:48:13
TPCC/batch(%40)   913670         0      104459  104459   104459  348.19      104459   348.19       5.32             11.48            158.30           18.95                     1199572.49        14:50:35    14:55:37
TPCC/batch(%20)   822303         0      109523  109523   109523  365.07      109523   365.07       4.07             10.95            372.04           18.61                     1199546.70        14:56:41    15:01:43
TPCC/batch(%10)   274101         0      105706  105706   105706  352.34      105706   352.34       4.18             11.35            271.09           18.95                     1199564.59        15:06:16    15:11:18
TPCC/batch(%5)    822303         0      107080  107080   107080  356.88      107080   356.88       3.97             11.20            364.85           19.65                     1199638.05        15:12:02    15:17:05
TPCC ONLY         0              0      137435  137435   137435  458.10      137435   458.10       3.91             8.73             238.56           12.75                     1199443.99        15:43:13    15:48:16
TPCC/batch        2649643        0      105991  105991   105991  353.25      105991   353.25       3.94             11.32            304.95           25.28                     1199620.69        15:48:56    15:53:59
TPCC/batch(%100)  1370505        0      111970  111970   111970  373.08      111970   373.08       3.96             10.71            761.59           20.00                     1199685.55        15:54:40    15:59:42
TPCC/batch(%80)   1279138        0      107689  107689   107689  358.95      107689   358.95       4.05             11.14            256.08           21.11                     1199565.71        16:01:51    16:06:54
TPCC/batch(%60)   1005037        0      112955  112955   112955  376.48      112955   376.48       3.89             10.62            207.52           18.95                     1199607.49        16:08:06    16:13:08
TPCC/batch(%40)   1005037        0      112837  112837   112837  376.12      112837   376.12       4.13             10.63            523.93           19.29                     1199518.78        16:14:18    16:19:20
TPCC/batch(%20)   1187771        0      112508  112508   112508  375.02      112508   375.02       4.01             10.66            245.91           20.00                     1199534.28        16:21:04    16:26:06
TPCC/batch(%10)   456835         0      127289  127289   127289  424.29      127289   424.29       3.89             9.42             282.97           15.00                     1199463.02        16:34:39    16:39:41
TPCC/batch(%5)    274101         0      130402  130402   130402  434.67      130402   434.67       3.99             9.20             252.79           13.95                     1199461.60        16:43:43    16:48:46
    #+END_SRC
  + Execution screenshot \\
    From above test case, we can see that as the resource controll's percentage decrease, the Row Inserted is decreasing at the similar rate. 
    #+ATTR_HTML: :width 800
    [[https://www.51yomo.net/static/doc/ResourceControl/011.png]]
  

  [[https://www.51yomo.net/static/doc/ResourceControl/resource-control.gif]]
